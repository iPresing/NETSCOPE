{% extends 'base.html' %}

{% block title %}Dashboard - NETSCOPE{% endblock %}

{% block content %}
<div class="dashboard-container">
    {# Configuration Capture Section #}
    <section class="capture-config card">
        <h2 class="card-title">Configuration Capture</h2>
        <div class="capture-form">
            <div class="form-group">
                <label for="capture-interface">Interface:</label>
                <select id="capture-interface" class="form-control">
                    <option value="auto">Auto (eth0)</option>
                    <option value="eth0">eth0 - Ethernet</option>
                    <option value="usb0">usb0 - USB Gadget</option>
                    <option value="wlan0">wlan0 - WiFi</option>
                </select>
            </div>
            <div class="form-group">
                <label for="capture-duration">Dur&eacute;e:</label>
                <select id="capture-duration" class="form-control">
                    <option value="30">30 secondes</option>
                    <option value="60">1 minute</option>
                    <option value="120" selected>2 minutes (d&eacute;faut)</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                </select>
            </div>
            <div class="form-group">
                <label for="capture-filter">Filtre BPF:</label>
                <input type="text" id="capture-filter" class="form-control" value="not port 22" placeholder="not port 22">
            </div>
            <div class="capture-actions">
                <button id="btn-start-capture" class="btn btn-primary btn-capture">
                    <span class="btn-icon">&#128640;</span>
                    Lancer Capture
                </button>
                <button id="btn-stop-capture" class="btn btn-danger btn-capture" style="display: none;">
                    <span class="btn-icon">&#9632;</span>
                    Arr&ecirc;ter
                </button>
            </div>
        </div>

        {# Capture Status Indicator #}
        <div id="capture-status" class="capture-status" style="display: none;">
            <span class="status-indicator running"></span>
            <span class="status-text">Capture en cours...</span>
            <span class="packet-animation">....&gt;</span>
            <span id="capture-timer" class="capture-timer">0s</span>
        </div>

        {# Capture Result #}
        <div id="capture-result" class="capture-result" style="display: none;">
            <div class="result-header">
                <span class="status-indicator completed"></span>
                <span class="result-title">Capture termin&eacute;e</span>
            </div>
            <div class="result-summary">
                <span id="result-packets">0 paquets</span> |
                <span id="result-duration">0s</span> |
                <span id="result-ips">0 IPs</span>
            </div>
        </div>

        {# Error Display #}
        <div id="capture-error" class="capture-error" style="display: none;">
            <span class="error-icon">&#9888;</span>
            <span id="error-message" class="error-message"></span>
        </div>
    </section>

    {# Score and Jobs Row #}
    <div class="dashboard-row">
        {# Score Sant&eacute; Section #}
        <section class="score-health card">
            <h2 class="card-title">Score Sant&eacute;</h2>
            <div class="score-display">
                <span class="score-value">--</span>
                <span class="score-max">/100</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <p class="score-percent">--%</p>
            <a href="#" class="btn btn-sm">D&eacute;tails</a>
        </section>

        {# Jobs Inspection Section #}
        <section class="jobs-inspection card">
            <h2 class="card-title">
                <span class="title-icon">&#128300;</span>
                Jobs Inspection
            </h2>
            <div class="jobs-placeholder">
                <p class="text-muted">Aucune capture effectu&eacute;e</p>
                <p class="text-muted text-sm">Les jobs d'inspection appara&icirc;tront ici</p>
            </div>
        </section>
    </div>

    {# Blacklists Actives Section #}
    <section class="blacklists-section card">
        <h2 class="card-title">
            <span class="title-icon">&#128737;</span>
            Blacklists Actives
        </h2>
        <div class="blacklist-stats">
            <div class="blacklist-stat">
                <span class="blacklist-stat-icon">&#127760;</span>
                <span class="blacklist-stat-label">IPs</span>
                <span class="blacklist-stat-value" id="blacklist-ips-count">{{ blacklist_ips_count }}</span>
                <span class="blacklist-stat-unit">entr&eacute;es</span>
            </div>
            <div class="blacklist-stat">
                <span class="blacklist-stat-icon">&#128279;</span>
                <span class="blacklist-stat-label">Domaines</span>
                <span class="blacklist-stat-value" id="blacklist-domains-count">{{ blacklist_domains_count }}</span>
                <span class="blacklist-stat-unit">entr&eacute;es</span>
            </div>
            <div class="blacklist-stat">
                <span class="blacklist-stat-icon">&#128221;</span>
                <span class="blacklist-stat-label">Termes</span>
                <span class="blacklist-stat-value" id="blacklist-terms-count">{{ blacklist_terms_count }}</span>
                <span class="blacklist-stat-unit">entr&eacute;es</span>
            </div>
        </div>
        <div class="blacklist-summary">
            <span class="blacklist-total">Total: <strong id="blacklist-total">{{ blacklist_total_entries }}</strong> entr&eacute;es</span>
            <button id="btn-reload-blacklists" class="btn btn-sm" title="Recharger les blacklists">
                &#128260; Recharger
            </button>
        </div>
    </section>

    {# Status Cards Row - Story 2.6: 4 Cartes Status avec indicateurs dynamiques #}
    <div class="status-cards">
        <div class="status-card card" id="card-ips" data-card-type="ips">
            <div class="status-card-header">
                <span class="status-indicator status-inactive" id="indicator-ips"></span>
                <span class="status-title">TOP IPs</span>
            </div>
            <div class="status-card-value" id="stat-top-ips">--</div>
            <div class="status-card-details" id="stat-top-ips-list">
                <span class="status-message">Lancez une capture pour voir les analyses</span>
            </div>
            <a href="{{ url_for('dashboard.anomalies') }}" class="status-card-link">Voir &rarr;</a>
        </div>

        <div class="status-card card" id="card-protocols" data-card-type="protocols">
            <div class="status-card-header">
                <span class="status-indicator status-inactive" id="indicator-protocols"></span>
                <span class="status-title">PROTOCOLES</span>
            </div>
            <div class="status-card-value" id="stat-protocols">--</div>
            <div class="status-card-details" id="stat-protocols-list">
                <span class="status-message">Lancez une capture pour voir les analyses</span>
            </div>
            <a href="{{ url_for('dashboard.anomalies') }}" class="status-card-link">Voir &rarr;</a>
        </div>

        <div class="status-card card" id="card-ports" data-card-type="ports">
            <div class="status-card-header">
                <span class="status-indicator status-inactive" id="indicator-ports"></span>
                <span class="status-title">PORTS</span>
            </div>
            <div class="status-card-value" id="stat-ports">--</div>
            <div class="status-card-details" id="stat-top-ports-list">
                <span class="status-message">Lancez une capture pour voir les analyses</span>
            </div>
            <a href="{{ url_for('dashboard.anomalies') }}" class="status-card-link">Voir &rarr;</a>
        </div>

        <div class="status-card card" id="card-volume" data-card-type="volume">
            <div class="status-card-header">
                <span class="status-indicator status-inactive" id="indicator-volume"></span>
                <span class="status-title">VOLUME</span>
            </div>
            <div class="status-card-value" id="stat-volume">--</div>
            <div class="status-card-details" id="stat-volume-bytes">
                <span class="status-message">Lancez une capture pour voir les analyses</span>
            </div>
        </div>
    </div>

    {# Four Essentials Detail Modal - Story 2.6 #}
    <div id="essentials-modal" class="essentials-modal" style="display: none;">
        <div class="essentials-modal-content card">
            <div class="essentials-modal-header">
                <h3 id="essentials-modal-title">D&eacute;tails</h3>
                <button id="btn-close-essentials-modal" class="btn btn-sm btn-danger">&times;</button>
            </div>
            <div id="essentials-modal-body" class="essentials-modal-body">
                {# Content populated by JavaScript #}
            </div>
        </div>
    </div>

    {# Anomalies Section - Story 2.2 #}
    <section id="anomalies-section" class="anomalies-section card" style="display: none;">
        <h2 class="card-title">
            <span class="title-icon">&#128680;</span>
            ANOMALIES D&Eacute;TECT&Eacute;ES
            <span id="anomalies-count" class="anomalies-badge">0</span>
        </h2>
        <div id="anomalies-list" class="anomalies-list">
            <p class="text-muted text-center">Aucune anomalie d&eacute;tect&eacute;e</p>
        </div>
        <div class="anomalies-summary">
            <span class="anomaly-stat">
                <span class="anomaly-stat-icon critical">&#128308;</span>
                Critique: <strong id="anomalies-critical">0</strong>
            </span>
            <span class="anomaly-stat">
                <span class="anomaly-stat-icon warning">&#128993;</span>
                Attention: <strong id="anomalies-warning">0</strong>
            </span>
        </div>
    </section>

    {# Detailed Results Section #}
    <section id="capture-results-section" class="capture-results card" style="display: none;">
        <h2 class="card-title">R&eacute;sultats Capture</h2>

        <div class="results-summary-row">
            <div class="result-stat">
                <span class="result-stat-label">Paquets</span>
                <span class="result-stat-value" id="result-total-packets">0</span>
            </div>
            <div class="result-stat">
                <span class="result-stat-label">Dur&eacute;e</span>
                <span class="result-stat-value" id="result-duration-formatted">0s</span>
            </div>
            <div class="result-stat">
                <span class="result-stat-label">Volume</span>
                <span class="result-stat-value" id="result-volume-formatted">0 B</span>
            </div>
            <div class="result-stat">
                <span class="result-stat-label">IPs Uniques</span>
                <span class="result-stat-value" id="result-unique-ips">0</span>
            </div>
        </div>

        <div class="results-tables-row">
            {# Top IPs Table #}
            <div class="results-table-container">
                <h3 class="results-table-title">Top 5 IPs</h3>
                <table class="results-table data-table">
                    <thead>
                        <tr>
                            <th>IP</th>
                            <th>Paquets</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="top-ips-table-body">
                        <tr class="placeholder-row">
                            <td colspan="3" class="text-muted text-center">Aucune donn&eacute;e</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            {# Top Ports Table #}
            <div class="results-table-container">
                <h3 class="results-table-title">Top 5 Ports</h3>
                <table class="results-table data-table">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Paquets</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="top-ports-table-body">
                        <tr class="placeholder-row">
                            <td colspan="3" class="text-muted text-center">Aucune donn&eacute;e</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# Protocols Distribution #}
        <div class="protocols-distribution">
            <h3 class="results-table-title">Distribution Protocoles</h3>
            <div id="protocols-bars" class="protocols-bars">
                <div class="protocol-placeholder text-muted text-center">Aucune donn&eacute;e</div>
            </div>
        </div>

        {# Raw Data Button #}
        <div class="raw-data-actions">
            <button id="btn-show-raw-data" class="btn btn-sm">
                Voir Donn&eacute;es Brutes
            </button>
        </div>
    </section>

    {# Raw Data Modal/Section #}
    <section id="raw-data-section" class="raw-data-section card" style="display: none;">
        <div class="raw-data-header">
            <h2 class="card-title">Donn&eacute;es Brutes</h2>
            <button id="btn-close-raw-data" class="btn btn-sm btn-danger">Fermer</button>
        </div>
        <p class="text-muted text-sm">Affichage des 100 premiers paquets</p>
        <div class="raw-data-table-wrapper">
            <table class="raw-data-table data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Src</th>
                        <th>IP Dst</th>
                        <th>Port Src</th>
                        <th>Port Dst</th>
                        <th>Proto</th>
                        <th>Taille</th>
                    </tr>
                </thead>
                <tbody id="raw-data-table-body">
                    <tr class="placeholder-row">
                        <td colspan="7" class="text-muted text-center">Chargement...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/capture.js') }}"></script>
{% endblock %}
